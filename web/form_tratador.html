<!DOCTYPE html>

<body>

<div class="title-row">
  <h1>Tratador</h1>
</div>

<div class='button-row'>
  <button class="add_button" onclick="addElement()">Adcionar</button>
  <button class="add_button" onclick="attElements()">Restaurar</button>
  <button class="add_button" onclick='removeAll()'>Limpar</button>
</div>

<form class='form-basic' name='tratador' id='tratador-agenda'>
  <div class='line-row'>
    <span>Horário</span>
    <span>Ração (kg)</span>
  </div>

</form>

<script type="text/javascript">

  var i = 0; /* Set Global Variable i */
  function increment(){
  i += 1; /* Function for automatic increment of field's "Name" attribute. */
  }

  // mascara dos campos de tempo
  var timeMask = {translation: {
                                H: {pattern: /[0-2]/, optional: true},
                                h: {pattern: /[0-9]/},
                                M: {pattern: /[0-5]/},
                                m: {pattern: /[0-9]/}
                                    },
                      placeholder: '__:__'
  };
  /*
  Tirado do site: https://www.formget.com/how-to-dynamically-add-and-remove-form-fields-using-javascript/
  ---------------------------------------------
  Function to Remove Form Elements Dynamically
  ---------------------------------------------

  */
  function removeElement(parentDiv, childDiv){
    if (childDiv == parentDiv){
      alert("The parent div cannot be removed.");
    }
    else if (document.getElementById(childDiv)){
      var child = document.getElementById(childDiv);
      var parent = document.getElementById(parentDiv);
      parent.removeChild(child);
    }
    else{
      alert("Child div has already been removed or does not exist.");
      return false;
    }
  }
  /*
  ----------------------------------------------------------------------------
  Functions that will be called upon, when user click on the Name text field.
  ----------------------------------------------------------------------------
  */
  function addElement(h=null, q=null){
    var div = document.createElement('div');
    div.setAttribute("id", "id_" + i);
    div.classList.add("line-row", "input_field");

    var hour = document.createElement("input");
    hour.setAttribute("type", "text");
    hour.setAttribute("name", "list" + i + "_hora");
    hour.classList.add('input_list');
    $(hour).mask("Hh:Mm", timeMask);
    if (h) hour.value = h;

    var quantidade = document.createElement("input");
    quantidade.setAttribute("type", "text");
    quantidade.setAttribute("min", "0")
    quantidade.setAttribute("name","list" + i + "_quantidade");
    quantidade.setAttribute("placeholder", "kg");
    quantidade.classList.add('input_list');
    //$(quantidade).mask('#00,0', {reverse: true});
    $(quantidade).mask("0#");
    if (q) quantidade.value =q;

    var close = document.createElement("img");
    close.setAttribute("onclick",
                       "removeElement('tratador-agenda','id_" + i + "')");
    close.setAttribute("src", "assets/delete.png");

    increment();

    div.appendChild(hour);
    div.appendChild(quantidade);
    div.appendChild(close);

    document.getElementById("tratador-agenda").appendChild(div);
  }
  /*
  -----------------------------------------------------------------------------
  Functions that will be called upon, when user click on the Reset Button.
  ------------------------------------------------------------------------------
  */
  function removeAll(){
    $('.input_field').remove();
    i = 0;
  }

  function removeAll(){
    $('.input_field').remove();
    i = 0;
  }

  function attElements(){
    get_status().then(

      function (msg) {
        msg = JSON.parse(msg);
        //console.log(msg);
        var elementos = msg['tratador'];

        if (elementos) {
          removeAll();
          for (var el in elementos) {
            addElement(elementos[el][0], elementos[el][1]);
          }
        }
      }, function (erro) {
        console.log(erro);
      }
    );
  }
  // Atualiza os campos depois de carregar a página
  attElements();

</script>
</body>
